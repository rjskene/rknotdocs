{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Key Concepts ##"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "RKnot builds a simulation across four dimensions of global properties:\n",
    "\n",
    "* Time\n",
    "    * The fundamental unit of time is a `tick`. \n",
    "    * Each iteration of the simulation is one tick. During a tick, the following occurs:\n",
    "        * subjects can move to new locations\n",
    "        * subjects can have contact with other subjects (at the same location)\n",
    "        * attributes of the subjects can change, including whether or not they are infected, if they have recovered, if they are once again susceptible, what parts of the grid they have access to etc.\n",
    "    * in the real world, many of the fundamental properties of a virus as measured in days (i.e. recovery rate or duration of immunity). RKnot translates these inputs into ticks.\n",
    "    * Currently, RKnot only supports a `tick` is equal to one day. The goal is to support any number of ticks during a day.\n",
    "* Space\n",
    "    * Subjects interact in an two-dimensional environment called the Grid.\n",
    "    * The Grid *must* be a square. The Grid size can be passed manually or it can be determined automatically for a specified degree of desired density.\n",
    "    * Each pair of x,y coordinates in the Grid is a location. A single subject can only occupy a single location at once. There is no limit to the number of different subjects that can occupy a single location at once.\n",
    "    * A \"contact\" occurs when an infected subject and a susceptible subject occupy the same location on the same tick.\n",
    "    * Subjects move through the Grid according to user-specified `mover` functions. These `mover` functions typically incorporate a degree of randomness.\n",
    "    * A subject can also move by subscribing to an Event. An Event can occur at any location on any tick (unless a Restriction or Quarantine applies) and can nominate a certain number of dots to subscribe/attend.\n",
    "    * Portions of the Grid may be restricted by Boxes and/or Gates.\n",
    "\n",
    "* Subjects\n",
    "    * subjects (also referred to as \"dots\") are the analog to people in the simulation.\n",
    "    * subjects carry many attributes through the life of the simulation that are updated and changed as required.\n",
    "    * all attributes of all subjects are tracked in the [Dot Matrix](#Dot-Matrix).\n",
    "* Virus\n",
    "    * the sim houses several characteristics fundamental to the simulated virus are passed including:\n",
    "        * $R_0$\n",
    "        * Duration of Infectiousness\n",
    "        * Duration of Immunity\n",
    "        * Infection Fatality Rate\n",
    "        * Transmission Rate (inferred from )\n",
    "        * Infectiousness Curve (aka Viral Load) - TBD"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### The Sim ###\n",
    "The `Sim` object is the user interface for the RKnot simulation package. A Sim object is instantiated with pre-defined characteristics of the space, the subjects, and the virus ([source](#)).\n",
    "\n",
    "For demonstration purposes, a quick default simulation can be run by simply providing a few parameters."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "### HIDDEN CELL ###\n",
    "%load_ext autoreload\n",
    "%autoreload 2\n",
    "\n",
    "from IPython.core.display import HTML\n",
    "\n",
    "import matplotlib\n",
    "matplotlib.use('Qt5Agg')\n",
    "\n",
    "from matplotlib.animation import FFMpegWriter\n",
    "\n",
    "import ray\n",
    "ray.shutdown()\n",
    "\n",
    "RUN = F\n",
    "SHOW_CHARTS = False\n",
    "SAVE_CHARTS = True"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "scrolled": false
   },
   "source": [
    "```python\n",
    "from rknot import Sim, Chart\n",
    "\n",
    "params = {'square': 4, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "sim = Sim(**params)\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "`run` is the main method of the `Sim` object. `run` loops through each `tick` in the simulation, calling the `next` method for each `tick`.\n",
    "\n",
    "`i_tick` is the current tick in the sim. `ticks` is the total."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "sim.run()\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "`sim.run()` does not return any values, but it does update various attributes of the `sim` object. After calling `run`, you can then pass `sim` to the `Chart` object, which will generate an animation of the simulation across time."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "chart = Chart(sim, dot_size=2000, interval=200)\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "1820d512b9bb48a0a6098befbafa47bb",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "a31ae4874c29404ba7e348aed9a86baa",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=71.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:439: UserWarning: Attempting to set identical left == right == 0 results in singular transformations; automatically expanding.\n",
      "  self.ax.set_xlim(0, xlim)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:323: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.max.set_alpha(0.5*i_currmax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:327: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.hit.set_alpha(0.5*imax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:445: UserWarning: Attempting to set identical left == right == 0 results in singular transformations; automatically expanding.\n",
      "  self.depper.axes.set_xlim(0, xlim)\n"
     ]
    }
   ],
   "source": [
    "if RUN:\n",
    "    from rknot import Sim, Chart\n",
    "    params = {'square': 4, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "    sim = Sim(**params)\n",
    "    sim.run()\n",
    "    chart = Chart(sim, dot_size=2000, interval=200)\n",
    "if SHOW_CHARTS:    \n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/intro.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/intro.mp4' controls>alternative text</video>\n",
    "<br>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The animation is split in 3 sections: \n",
    "\n",
    "* **Infections**\n",
    "    * shows the change in infection level over each day, showing both current infection level and total penetration ('Ever')\n",
    "* **Details**\n",
    "    * provides several on-the-run statistics including Effective Reproduction Number, total fatalities, and fatalities by group.\n",
    "* **Interactions**\n",
    "    * the visual representation of the Grid. Each marker is a subject and each cross-section of gridlines is a point (for larger grids the lines are removed).\n",
    "    \n",
    "The animation is broken up into components that can be viewed in various preset configurations. [see Chart for more details](#Chart)."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "As per the animation, the default simulation is of a single infected subject, moving across a 4x4 two-dimensional space according to the `equal` mover function. The subject is equally likely to move to any location in the Grid on any tick."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Subjects ###"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Dots ###\n",
    "Dots are equivalent to subjects/people in the simulation space. A subject has many attributes that are adjusted during the course of a simulation, including:\n",
    "\n",
    "* which Group it belongs to\n",
    "* if it is alive\n",
    "* if it is infected\n",
    "* if it is susceptible\n",
    "* its location\n",
    "* any restricted areas that apply to it ([see Boxes and Gates](#Boxes-and-Gates))\n",
    "* if infected, when it will recover (or when it will succumb)\n",
    "* if recovered, when it will again become susceptible\n",
    "* what its fatality rate is\n",
    "* its `mover` function\n",
    "\n",
    "[see Dot Matrix](#Dot-Matrix) for a more fulsome discussion."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Groups ####\n",
    "Dots are the fundamental subjects of the simulation, but dots can **only** be created via a Group object.\n",
    "\n",
    "To create our group objects, we can pass a list of dictionaries to the `groups` parameter of Sim. The dictionaries correspond to the attributes of the group, which in turn correspond to the attributes of its constituent dots at initiation.\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "To create a group, you need only provide two parameters:\n",
    "\n",
    "* `n`, population size of the group at initiation\n",
    "* `n_inf`, number of infected subjects in the group at initiation"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "*If only one group is being provided, you can pass a dictionary. With multiple groups, pass an iterable of dicts.*"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "group = dict(n=2, n_inf=1)\n",
    "\n",
    "sim = Sim(groups=group, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, figsize=(16,8), dot_size=2000, interval=200,\n",
    "    config='dots_only', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Below we see this structure create a 10x10 Grid with two subjects, only one of which is infected at the outset."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "3cdc29c876de4d52bf21885f5a7bce59",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "bcbed01f63624b9a9b9ffd416586ddff",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "    group = dict(n=2, n_inf=1)\n",
    "\n",
    "    sim = Sim(groups=group, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, figsize=(16,8), dot_size=2000, interval=200,\n",
    "        config='dots_only', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/group1.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/group1.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "There are many other additional parameters and customizations that can provided:\n",
    "\n",
    "* `name`\n",
    "    * if not provided, Sim will create one, but it is highly recommended that you provide a name\n",
    "* `box` & `gates` \n",
    "    * see [Boxes and Gates](#Boxes-and-Gates)\n",
    "* `mover`\n",
    "    * selects the function used to dictate a dot's movement ([see Mover Functions](#Mover-Functions))\n",
    "* `tmf`\n",
    "    * this is the *transmission factor*, $\\tau$, applied to each of the dots interactions.\n",
    "    * default: 1\n",
    "* `susf`\n",
    "    * meaning *susceptiblity factor*; this is the fraction of subjects in a group that will be made susceptible to the virus at initiation\n",
    "    * in other words, the inverse of `susf` ($1/{susf}$) is the number of subjects in a group that already have immunity.\n",
    "* `ifr`\n",
    "    * meaning *infection fatality rate*; or the likelihood that an infection of a subject will be fatal"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "These can again be passed as a dictionary of a single group: "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group = dict(name='main', n=2, n_inf=1, mover='local', tmf=1.25, susf=.75, ifr=0.005)\n",
    "\n",
    "sim = Sim(groups=group, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, figsize=(16,8), dot_size=2000, interval=200, \n",
    "    config='dots_only', show_intro=False\n",
    ") \n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "37acbd37057c4cb8836b38dad3df5ffb",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "4ef68960bc1143c2abddcb167be1bcb1",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    group = dict(name='main', n=2, n_inf=1, mover='local', tmf=1.25, susf=.75, ifr=0.005)\n",
    "\n",
    "    sim = Sim(groups=group, **params)\n",
    "    sim.run()\n",
    "\n",
    "    chart = Chart(\n",
    "        sim, figsize=(16,8), dot_size=2000, interval=200, \n",
    "        config='dots_only', show_intro=False\n",
    "    ) \n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/group2.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/group2.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Or as an iterable of dictionaries for multiple groups. Each group is assigned a unique marker in the animation."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group1 = dict(name='1', n=1, n_inf=1, mover='local', tmf=1.25, susf=.75, ifr=0.005)\n",
    "group2 = dict(name='1', n=1, n_inf=0, mover='equal', tmf=0.75, susf=0.95, ifr=0.05)\n",
    "groups = [group1, group2]\n",
    "\n",
    "sim = Sim(groups=groups, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, figsize=(16,8), dot_size=2000, interval=200, \n",
    "    config='dots_only', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "c19943f8853f4b7d913d982010b3fb67",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\n",
      "\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "cbf299d2e86e466cad8197c0c3ebc1f9",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    group1 = dict(name='1', n=1, n_inf=1, mover='local', tmf=1.25, susf=.75, ifr=0.005)\n",
    "    group2 = dict(name='1', n=1, n_inf=0, mover='equal', tmf=0.75, susf=0.95, ifr=0.05)\n",
    "    groups = [group1, group2]\n",
    "\n",
    "    sim = Sim(groups=groups, **params)\n",
    "    sim.run()\n",
    "\n",
    "    chart = Chart(\n",
    "        sim, figsize=(16,8), dot_size=2000, interval=200, \n",
    "        config='dots_only', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/group3.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/group3.mp4' controls>alternative text</video>\n",
    "<br>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### The Grid ###\n",
    "\n",
    "All subject interactions in an RKnot simulation take place inside the Grid. The grid is a `Grid` object, which is in turn is a sub-classed numpy array with some additional features.\n",
    "\n",
    "The Grid size can be determined by passing the `square` parameter (as per above) or by passing the `dlevel` parameter (short for density level). Each `dlevel` corresponds to a certain density of the population in the Grid.\n",
    "\n",
    "Available `dlevel` options are:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {
    "hide_input": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'low': 0.2, 'med': 1, 'high': 10}"
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "Sim.DENSITIES"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "If we set `dlevel=med`, the Grid will be set such that the density is 1 subject per location. For a group of 100 subjects, that will result in a 10x10 grid. We can see these attributes by also passing `details=True`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2020-10-12 13:50:28,944\tINFO resource_spec.py:223 -- Starting Ray with 12.11 GiB memory available for workers and up to 6.08 GiB for objects. You can adjust these settings with ray.init(memory=<bytes>, object_store_memory=<bytes>).\n",
      "2020-10-12 13:50:29,337\tINFO services.py:1191 -- View the Ray dashboard at \u001b[1m\u001b[32mlocalhost:8265\u001b[39m\u001b[22m\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "---------------------------------------------------------------------------------\n",
      "|                                  SIM DETAILS                                  |\n",
      "|-------------------------------------------------------------------------------|\n",
      "|           boundary|      [ 1 10  1 10]|             n_locs|                100|\n",
      "|-------------------|-------------------|-------------------|-------------------|\n",
      "|                  n|                100|            density|                1.0|\n",
      "|-------------------|-------------------|-------------------|-------------------|\n",
      "|                ktr|               1.01|                tmr|               0.01|\n",
      "|-------------------|-------------------|-------------------|-------------------|\n"
     ]
    }
   ],
   "source": [
    "params = {'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "group = dict(name='main', n=100, n_inf=1)\n",
    "\n",
    "sim = Sim(groups=group, dlevel='med', details=True, **params)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "dc5df9b3edd5454e8ee8487592e455a4",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "571cb12c918945d4992f0daba0001ab0",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    }
   ],
   "source": [
    "if RUN:\n",
    "    sim.run()\n",
    "    chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/grid1.mp4', writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/grid1.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "For smaller populations, the density level can only of course be approximated. RKnot defaults to rounding up to the nearest square value (which is rounding down the density).\n",
    "\n",
    "Passing `dlevel='high'` on popuation of 1,020 subjects results in an 11x11 grid (121 locations or 8.42 subjects per location)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2020-10-12 13:50:48,730\tINFO resource_spec.py:223 -- Starting Ray with 12.11 GiB memory available for workers and up to 6.07 GiB for objects. You can adjust these settings with ray.init(memory=<bytes>, object_store_memory=<bytes>).\n",
      "2020-10-12 13:50:49,130\tINFO services.py:1191 -- View the Ray dashboard at \u001b[1m\u001b[32mlocalhost:8265\u001b[39m\u001b[22m\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "---------------------------------------------------------------------------------\n",
      "|                                  SIM DETAILS                                  |\n",
      "|-------------------------------------------------------------------------------|\n",
      "|           boundary|      [ 1 11  1 11]|             n_locs|                121|\n",
      "|-------------------|-------------------|-------------------|-------------------|\n",
      "|                  n|               1020|            density|  8.429752066115702|\n",
      "|-------------------|-------------------|-------------------|-------------------|\n",
      "|                ktr|                8.5|                tmr|                0.0|\n",
      "|-------------------|-------------------|-------------------|-------------------|\n"
     ]
    }
   ],
   "source": [
    "group1 = dict(name='1', n=1000, n_inf=1)\n",
    "group2 = dict(name='2', n=20, n_inf=20)\n",
    "groups = [group1, group2]\n",
    "\n",
    "sim = Sim(groups=groups, dlevel='high', details=True, **params)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "53cd8b35a67f443d9561698d03870f7e",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "fb12064a76f64a5b9193e403e30a53f4",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    sim.run()\n",
    "    chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/grid2.mp4', writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/grid2.mp4' controls>alternative text</video>\n",
    "<br>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### MOVER FUNCTIONS ####"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "metadata": {
    "hide_input": true,
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "from IPython.display import Markdown as md\n",
    "\n",
    "from rknot.space import MOVER_NAMES\n",
    "msg = \"When a subject changes locations, this is called a 'move'. A move is \"\n",
    "msg += \"completed during a tick and \"\n",
    "msg += \"the movement of a subject on any tick is governed by its `mover` function. \"\n",
    "msg += \"Movers select a location according to a pre-defined probability distribution, \"\n",
    "msg += \"so the general movement pattern of a dot can be pre-determined, but any one movement \"\n",
    "msg += \"occurs randomly. \\n\\n\"\n",
    "msg += \"There are currently {} mover functions. \".format(len(MOVER_NAMES))\n",
    "msg += \"Their respective definitions, along with examples of their movement are provided below.\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "metadata": {
    "hide_input": true
   },
   "outputs": [
    {
     "data": {
      "text/markdown": [
       "When a subject changes locations, this is called a 'move'. A move is completed during a tick and the movement of a subject on any tick is governed by its `mover` function. Movers select a location according to a pre-defined probability distribution, so the general movement pattern of a dot can be pre-determined, but any one movement occurs randomly. \n",
       "\n",
       "There are currently 5 mover functions. Their respective definitions, along with examples of their movement are provided below."
      ],
      "text/plain": [
       "<IPython.core.display.Markdown object>"
      ]
     },
     "execution_count": 17,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "md(msg)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2020-10-12 13:51:11,818\tINFO resource_spec.py:223 -- Starting Ray with 12.11 GiB memory available for workers and up to 6.06 GiB for objects. You can adjust these settings with ray.init(memory=<bytes>, object_store_memory=<bytes>).\n",
      "2020-10-12 13:51:12,212\tINFO services.py:1191 -- View the Ray dashboard at \u001b[1m\u001b[32mlocalhost:8265\u001b[39m\u001b[22m\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "ecbccabf10584ee799f5e389a14dac51",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "e75d24727870425393ab88717efff626",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2020-10-12 13:51:32,739\tINFO resource_spec.py:223 -- Starting Ray with 12.01 GiB memory available for workers and up to 6.03 GiB for objects. You can adjust these settings with ray.init(memory=<bytes>, object_store_memory=<bytes>).\n",
      "2020-10-12 13:51:33,134\tINFO services.py:1191 -- View the Ray dashboard at \u001b[1m\u001b[32mlocalhost:8265\u001b[39m\u001b[22m\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "47fc661cb3cc4267a569ec86e25235e0",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "c7aaed4ca73240b2bbc73a9c5ea0c6b3",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2020-10-12 13:51:54,922\tINFO resource_spec.py:223 -- Starting Ray with 12.06 GiB memory available for workers and up to 6.05 GiB for objects. You can adjust these settings with ray.init(memory=<bytes>, object_store_memory=<bytes>).\n",
      "2020-10-12 13:51:55,310\tINFO services.py:1191 -- View the Ray dashboard at \u001b[1m\u001b[32mlocalhost:8265\u001b[39m\u001b[22m\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "b19af1af726b4832aaf55d4ce942f01c",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "bf02bca9f90a4dd7ab591ecea7086917",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\n",
      "\n",
      "\n",
      "\n",
      "\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2020-10-12 13:52:16,339\tINFO resource_spec.py:223 -- Starting Ray with 12.06 GiB memory available for workers and up to 6.05 GiB for objects. You can adjust these settings with ray.init(memory=<bytes>, object_store_memory=<bytes>).\n",
      "2020-10-12 13:52:16,731\tINFO services.py:1191 -- View the Ray dashboard at \u001b[1m\u001b[32mlocalhost:8265\u001b[39m\u001b[22m\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "12aa53d6c07844dab21eab825893a2c3",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "95ecb7ac3b754524802c8bda6220b3e0",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2020-10-12 13:52:37,557\tINFO resource_spec.py:223 -- Starting Ray with 12.01 GiB memory available for workers and up to 6.02 GiB for objects. You can adjust these settings with ray.init(memory=<bytes>, object_store_memory=<bytes>).\n",
      "2020-10-12 13:52:37,956\tINFO services.py:1191 -- View the Ray dashboard at \u001b[1m\u001b[32mlocalhost:8265\u001b[39m\u001b[22m\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "ef5f4469984241ddbc57feffc10ff6e2",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "0fdd42b7d11c4f76beb06b63f101c798",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "### HIDDEN ###\n",
    "from rknot.space import MOVERS\n",
    "if SAVE_CHARTS:\n",
    "    for mover in MOVERS:\n",
    "        group1 = dict(name='1', n=1, n_inf=1, mover=mover.__name__)\n",
    "\n",
    "        sim = Sim(groups=group1, square=10, **params)\n",
    "        sim.run()\n",
    "\n",
    "        chart = Chart(sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False)\n",
    "        chart.animate.save('vids/concepts/{}.mp4'.format(mover.__name__), writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "from rknot.space.movers import MOVER_DEFNS\n",
    "text = ''\n",
    "for i, mover in enumerate(MOVER_NAMES):\n",
    "    text += '* {} \\n'.format(mover.capitalize())\n",
    "    text += '    * {} \\n'.format(MOVER_DEFNS[i])\n",
    "    text += \"\"\"\n",
    "        <video width='705' height='340' \n",
    "        src='https://storage.googleapis.com/rknotvids/keycons/{}.mp4' controls>alternative text</video>\n",
    "    \"\"\".format(mover)\n",
    "    text += ' \\n'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {
    "hide_input": true
   },
   "outputs": [
    {
     "data": {
      "text/markdown": [
       "* Equal \n",
       "    * The subject is equally likely to move any location. \n",
       "\n",
       "        <video width='705' height='340' \n",
       "        src='https://storage.googleapis.com/rknotvids/keycons/equal.mp4' controls>alternative text</video>\n",
       "     \n",
       "* Local \n",
       "    * The subject has a strong bias towards dots only in its immediate vicinity. \n",
       "\n",
       "        <video width='705' height='340' \n",
       "        src='https://storage.googleapis.com/rknotvids/keycons/local.mp4' controls>alternative text</video>\n",
       "     \n",
       "* Traveller \n",
       "    * The subject commonly moves to locations far across the Grid. \n",
       "\n",
       "        <video width='705' height='340' \n",
       "        src='https://storage.googleapis.com/rknotvids/keycons/traveller.mp4' controls>alternative text</video>\n",
       "     \n",
       "* Quarantine \n",
       "    * The subject has a strong bias towards not moving, with only some movement occuring. \n",
       "\n",
       "        <video width='705' height='340' \n",
       "        src='https://storage.googleapis.com/rknotvids/keycons/quarantine.mp4' controls>alternative text</video>\n",
       "     \n",
       "* Social \n",
       "    * The subject moves mostly within its vicinty but also to other more medium distance location. \n",
       "\n",
       "        <video width='705' height='340' \n",
       "        src='https://storage.googleapis.com/rknotvids/keycons/social.mp4' controls>alternative text</video>\n",
       "     \n"
      ],
      "text/plain": [
       "<IPython.core.display.Markdown object>"
      ]
     },
     "execution_count": 20,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "md(text)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Movement can also be governed by [Boxes and Gates](#Boxes-and-Gates) or [Events](#Events).\n",
    " "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Boxes and Gates ###\n",
    "The movement of a subject across the Grid can be restricted by two concepts known as Boxes and Gates. These concepts are designed to mimick certain funcitonal or perceived boundaries between groups, such as international borders or closed-access communities like assisted-living facilities.\n",
    "\n",
    "The distinction between boxes and gates is simple:\n",
    "\n",
    "* Boxes: *cannot* **exit**\n",
    "* Gates: *cannot* **enter**"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Boxes ####\n",
    "A box is a $m*n$ subset of locations within the Grid that a subject(s) cannot leave.\n",
    "\n",
    "The locations are specified by passing a four element iterable that specifies the coordinates of the \"four corners\" of the box according to [$x_0$, $x_1$, $y_0$, $y_1$]\n",
    "\n",
    "So passing:\n",
    "```python\n",
    "box = [2,6,3,9]\n",
    "```\n",
    "creates a box with four corners:\n",
    "```python\n",
    "(2,3)   (2,9)    (6,3)   (6,9)\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "from rknot.space import Grid\n",
    "box = Grid([2,6,3,9], square=10)\n",
    "msg = \"and a total of {} locations.\".format(box.n_locs)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {
    "hide_input": true
   },
   "outputs": [
    {
     "data": {
      "text/markdown": [
       "and a total of 35 locations."
      ],
      "text/plain": [
       "<IPython.core.display.Markdown object>"
      ]
     },
     "execution_count": 22,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "md(msg)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Currently, a box *can only be specified* by passing the `box` parameter as group keyword. When this is done, every dot in the group is only able to move with the `box`, regardless of the size of the Grid."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group1 = dict(name='1', n=2, n_inf=1, box=[1,3,2,4])\n",
    "\n",
    "sim = Sim(groups=group1, square=10, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False)\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "53f145e8004747399e18e7f6e07d3161",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "6266d7a64fce456c843ccb4de49a0f8a",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    group1 = dict(name='1', n=2, n_inf=1, box=[1,3,2,4])\n",
    "\n",
    "    sim = Sim(groups=group1, square=10, **params)    \n",
    "    sim.run()\n",
    "    \n",
    "    chart = Chart(sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False)\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/boxes1.mp4', writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/boxes1.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "A group can only have one box, but each group can have its own box."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group1 = dict(name='1', n=2, n_inf=1, box=[1,3,2,4])\n",
    "group2 = dict(name='1', n=2, n_inf=0, box=[6,9,6,10])\n",
    "groups = [group1, group2]\n",
    "\n",
    "sim = Sim(groups=groups, square=10, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "d961c89ec19e459fafa1c1d1d94f6bbc",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\n",
      "\n",
      "\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "f8b756845961482da6afd2450591d5ce",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    group1 = dict(name='1', n=2, n_inf=1, box=[1,3,2,4])\n",
    "    group2 = dict(name='1', n=2, n_inf=0, box=[6,9,6,10])\n",
    "    groups = [group1, group2]\n",
    "    \n",
    "    sim = Sim(groups=groups, square=10, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False)\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/boxes2.mp4', writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/boxes2.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Remember that a box only restricts the subjects in that group from *leaving* the space. Other dots not assigned to that box can move into the space without restriction."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group1 = dict(name='1', n=5, n_inf=1, box=[1,3,1,3])\n",
    "group2 = dict(name='1', n=5, n_inf=0)\n",
    "groups = [group1, group2]\n",
    "\n",
    "sim = Sim(groups=groups, square=10, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False)\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "2b4ecb6267204675bec337a921c7476c",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "b3353dd5e05c44aab47ec0501be52a8a",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    group1 = dict(name='1', n=5, n_inf=1, box=[1,3,1,3])\n",
    "    group2 = dict(name='1', n=5, n_inf=0)\n",
    "    groups = [group1, group2]\n",
    "\n",
    "    sim = Sim(groups=groups, square=10, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False)\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/boxes3.mp4', writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/boxes3.mp4' controls>alternative text</video>\n",
    "<br>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Gates ####\n",
    "Gates are the inverse of boxes. A gate is an area that subjects are cannot enter.\n",
    "\n",
    "Gates are a Gate object, which is a subclass of Grid, and they are created via the same 4 element iterable. For now, in a Sim, a gate can only be created by passing the `box_is_gated=True` flag as a keyword in a group dictionary.\n",
    "\n",
    "Using the previous example, with this flag set, we can see that `group2` dots can no longer enter the `group1` box."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group1 = dict(name='1', n=5, n_inf=1, box=[1,3,1,3], box_is_gated=True)\n",
    "group2 = dict(name='1', n=5, n_inf=0)\n",
    "groups = [group1, group2]\n",
    "\n",
    "sim = Sim(groups=groups, square=10, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "metadata": {
    "nbshpinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "3fa89e4135bc4e7bbf6bed8acb216836",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "40a4667b974d42d4a3747127caccf6b2",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    group1 = dict(name='1', n=5, n_inf=1, box=[1,3,1,3], box_is_gated=True)\n",
    "    group2 = dict(name='1', n=5, n_inf=0)\n",
    "    groups = [group1, group2]\n",
    "\n",
    "    sim = Sim(groups=groups, square=10, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, figsize=(16,8), dot_size=2000, config='dots_only', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/gates1.mp4', writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/gates1.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "This structure can lead to some intricate movement patterns of, say, only isolated groups:"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group1 = dict(name='1', n=50, n_inf=5, box=[1,5,1,20], box_is_gated=True)\n",
    "group2 = dict(name='2', n=50, n_inf=5, box=[6,25,3,10], box_is_gated=True)\n",
    "group3 = dict(name='3', n=50, n_inf=5, box=[10,21,16,22], box_is_gated=True)\n",
    "group4 = dict(name='4', n=50, n_inf=5, box=[2,15,23,25], box_is_gated=True)\n",
    "groups = [group1, group2, group3, group4]\n",
    "\n",
    "sim = Sim(groups=groups, square=25, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "691b2ff06afb467fbdee7d659496b3b3",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "928b9540783c4609b5a6773dc57832cf",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    }
   ],
   "source": [
    "if RUN:\n",
    "    group1 = dict(name='1', n=50, n_inf=5, box=[1,5,1,20], box_is_gated=True)\n",
    "    group2 = dict(name='2', n=50, n_inf=5, box=[6,25,3,10], box_is_gated=True)\n",
    "    group3 = dict(name='3', n=50, n_inf=5, box=[10,21,16,22], box_is_gated=True)\n",
    "    group4 = dict(name='4', n=50, n_inf=5, box=[2,15,23,25], box_is_gated=True)\n",
    "    groups = [group1, group2, group3, group4]\n",
    "\n",
    "    sim = Sim(groups=groups, square=25, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(sim, figsize=(16,8), dot_size=200, config='dots_only', show_intro=False)\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/gates2.mp4', writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/gates2.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Or some isolated groups and some free moving:"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group1 = dict(name='1', n=50, n_inf=5, box=[1,5,1,5], box_is_gated=True)\n",
    "group2 = dict(name='2', n=50, n_inf=5, box=[14,19,14,19], box_is_gated=True)\n",
    "group3 = dict(name='4', n=10, n_inf=5)\n",
    "group4 = dict(name='4', n=10, n_inf=5)\n",
    "groups = [group1, group2, group3, group4]\n",
    "\n",
    "sim = Sim(groups=groups, square=25, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "06b99c99d3cf47dea7d97e801c75c612",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "7a66bc4783be43829d28c290599bd584",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    }
   ],
   "source": [
    "if RUN:\n",
    "    group1 = dict(name='1', n=50, n_inf=5, box=[1,5,1,5], box_is_gated=True)\n",
    "    group2 = dict(name='2', n=50, n_inf=5, box=[14,19,14,19], box_is_gated=True)\n",
    "    group3 = dict(name='4', n=10, n_inf=5)\n",
    "    group4 = dict(name='4', n=10, n_inf=5)\n",
    "    groups = [group1, group2, group3, group4]\n",
    "\n",
    "    sim = Sim(groups=groups, square=25, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/gates3.mp4', writer=FFMpegWriter(fps=10))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/gates3.mp4' controls>alternative text</video>\n",
    "<br>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Events ###\n",
    "Events impact the attributes of subjects over the course of the simulation.\n",
    "\n",
    "Events can impact location, transmission factors, susceptibility, etc. Events can occur for one tick or more and they can recur on a periodic basis. Events typically impact a specified number of subjects.\n",
    "\n",
    "Events are utilized to better simulate real-world behavior. For instance, people do not move in consistent, prescribed ways. They move in regular ways most of the time with contacts that are well defined, but sometimes they attend events (perhaps periodically or unique) that are not governed by their regular movement patterns."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Event ####\n",
    "An `Event` is as event that occurs at a particular location.\n",
    "\n",
    "An `Event` accepts the following parameters:\n",
    "\n",
    "* `xy`, the x,y coordinates of the location\n",
    "* `start_tick`, the tick when the event begins\n",
    "* `groups`, an iterable of group ids that are eligible for the event\n",
    "* `capacity`, the number of subjects that should attend\n",
    "* `recurring`, how often the event recurs (i.e. every *nth* tick); if set to 0, the event does *not* recur\n",
    "\n",
    "When an `Event` concludes, the subject returns to its `home` location as specified in the dot matrix.\n",
    "\n",
    "To schedule an event, you must pass a list of event objects to the `events` parameter.\n",
    "\n",
    "To begin with, we'll create a single `Event` object, called `show`, that occurs once on the tick 5 of the sim."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "from rknot.events import Event\n",
    "\n",
    "params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "group1 = dict(name='1', n=10, n_inf=5)\n",
    "\n",
    "show = Event(name='show', xy=(5,5), start_tick=5, groups=[0], capacity=10)\n",
    "events = [show]\n",
    "\n",
    "sim = Sim(groups=group1, events=events, **params)\n",
    "sim.run(dotlog=True)\n",
    "\n",
    "chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 36,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "16335d04f5ee494a99356aa73c08de89",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\n",
      "\n",
      "\n",
      "\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "97cf88ce1f8b4adf971a3a483230543c",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    from rknot.events import Event\n",
    "\n",
    "    params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "    group1 = dict(name='1', n=10, n_inf=5)\n",
    "\n",
    "    show = Event(name='show', xy=(5,5), start_tick=5, groups=[0], capacity=10)\n",
    "    events = [show]\n",
    "\n",
    "    sim = Sim(groups=group1, events=events, **params)\n",
    "    sim.run(dotlog=True)\n",
    "    chart = Chart(sim, figsize=(16,8), config='dots_only', show_intro=False)\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/event1.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/event1.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "If you look closely at the animation (or pause it) on frame 6, you'll see that all the dots seemingly disappear, save for one, at location (5,5). \n",
    "\n",
    "In fact, all 10 dots are *actually at that location at the same time*.\n",
    "\n",
    "We can confirm this by inspecting the [Dot Matrix](#) at that tick via the `dotlog` attribute."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 37,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "array([[5, 5],\n",
       "       [5, 5],\n",
       "       [5, 5],\n",
       "       [5, 5],\n",
       "       [5, 5],\n",
       "       [5, 5],\n",
       "       [5, 5],\n",
       "       [5, 5],\n",
       "       [5, 5],\n",
       "       [5, 5]])"
      ]
     },
     "execution_count": 37,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from rknot.dots import MATRIX_COL_LABELS as ML\n",
    "sim.dotlog[5][:, ML['x']:ML['y']+1]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We can see the event more clearly if we extend the duration to 10 days. We also significantly reduced the frame rate."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "show = Event(name='show', xy=(5,5), start_tick=5, groups=[0], capacity=10, duration=10)\n",
    "events = [show]\n",
    "\n",
    "sim = Sim(groups=group1, events=events, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, figsize=(16,8), dot_size=1000, interval=300, \n",
    "    config='dots_only', show_intro=False\n",
    ")\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 39,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "f087a33ec45c4995a78749ab543e3ec2",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "1d65b444f6aa4301857c79039267b9d7",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    show = Event(name='show', xy=(5,5), start_tick=5, groups=[0], capacity=10, duration=10)\n",
    "    events = [show]\n",
    "\n",
    "    sim = Sim(groups=group1, events=events, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, figsize=(16,8), dot_size=1000, interval=300, \n",
    "        config='dots_only', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/event2.mp4', writer=FFMpegWriter(fps=2.5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/event2.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Many event objects can be specified at once, in various combinations of groups."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "group1 = dict(name='1', n=10, n_inf=5)\n",
    "group2 = dict(name='2', n=10, n_inf=0)\n",
    "\n",
    "show = Event(name='show', xy=(5,5), start_tick=5, groups=[0,1], capacity=5, recurring=30)\n",
    "game = Event(name='game', xy=(1,1), start_tick=5, groups=[0], capacity=5, recurring=14)\n",
    "church = Event(name='church', xy=(1,1), start_tick=5, groups=[1], capacity=10, recurring=7)\n",
    "\n",
    "groups = [group1, group2]\n",
    "events = [show, game, church]\n",
    "\n",
    "sim = Sim(groups=groups, events=events, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, interval=300, dot_size=1000, config='no_details', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 41,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "32be185df2c3412e8a202adf8948064f",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "fcfd948140774d74962af26412d69386",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    group1 = dict(name='1', n=10, n_inf=5)\n",
    "    group2 = dict(name='2', n=10, n_inf=0)\n",
    "\n",
    "    show = Event(name='show', xy=(5,5), start_tick=5, groups=[0,1], capacity=5, recurring=30)\n",
    "    game = Event(name='game', xy=(1,1), start_tick=5, groups=[0], capacity=5, recurring=14)\n",
    "    church = Event(name='church', xy=(1,1), start_tick=5, groups=[1], capacity=10, recurring=7)\n",
    "\n",
    "    groups = [group1, group2]\n",
    "    events = [show, game, church]\n",
    "\n",
    "    sim = Sim(groups=groups, events=events, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, interval=300, dot_size=1000, config='no_details', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/event3.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/event3.mp4' controls>alternative text</video>\n",
    "<br>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Travel ####\n",
    "Travel is a special type of event that allows a subject to enter a gate.\n",
    "\n",
    "When a dot(s) enters a gate via a Travel object, its box and gate attributes are temporarily adjusted to match those of the groups within the gate. The attributes are revert when the event expires (determined by `duration` parameter).\n",
    "\n",
    "Once inside the gate, the dot(s) are free to interact with other dots normally."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "from rknot.events import Travel\n",
    "\n",
    "params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "group1 = dict(name='1', n=1, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "group2 = dict(name='2', n=10, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "visit = Travel(\n",
    "    name='visit', xy=[1,1], start_tick=3, groups=[1], capacity=1, duration=5, recurring=10\n",
    ")\n",
    "\n",
    "groups = [group1, group2]\n",
    "events = [visit]\n",
    "\n",
    "sim = Sim(groups=groups, events=events, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, interval=200, dot_size=2000, config='no_details', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 44,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "49612186aa874ed195376dee9684339b",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/main.py:160: RuntimeWarning: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`).\n",
      "  self.fig = plt.figure(figsize=figsize)\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "72977e7719f54770b383e9b16af7b760",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:323: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.max.set_alpha(0.5*i_currmax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:327: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.hit.set_alpha(0.5*imax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:323: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.max.set_alpha(0.5*i_currmax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:327: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.hit.set_alpha(0.5*imax / argmax)\n"
     ]
    }
   ],
   "source": [
    "if RUN:\n",
    "    from rknot.events import Travel\n",
    "\n",
    "    params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "    group1 = dict(name='1', n=1, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "    group2 = dict(name='2', n=10, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "    visit = Travel(\n",
    "        name='visit', xy=[1,1], start_tick=3, groups=[1], capacity=1, duration=5, recurring=10\n",
    "    )\n",
    "\n",
    "    groups = [group1, group2]\n",
    "    events = [visit]\n",
    "\n",
    "    sim = Sim(groups=groups, events=events, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, interval=200, dot_size=2000, config='no_details', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/travel1.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/travel1.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Many unique configurations can be achieved with this structure. Below the `group1` box will be vacated by the solitary `group1` dot (essentially switching places with a dot from `group2`."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "from rknot.events import Travel\n",
    "\n",
    "params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "group1 = dict(name='1', n=1, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "group2 = dict(name='2', n=10, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "visit2 = Travel(\n",
    "    name='visit2', xy=[9,9], start_tick=3, groups=[0], capacity=1, duration=5, recurring=10\n",
    ")\n",
    "visit1 = Travel(\n",
    "    name='visit1', xy=[1,1], start_tick=3, groups=[1], capacity=1, duration=5, recurring=10\n",
    ")\n",
    "groups = [group1, group2]\n",
    "events = [visit2, visit1]\n",
    "\n",
    "sim = Sim(groups=groups, events=events, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, interval=200, dot_size=2000, config='no_details', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 47,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "f5faf0cdef5b4a2eaf556b996485cdba",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=50.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "8952c95fa5ea46158595a2f328b495b3",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=51.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\n",
      "\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:323: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.max.set_alpha(0.5*i_currmax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:327: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.hit.set_alpha(0.5*imax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:323: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.max.set_alpha(0.5*i_currmax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:327: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.hit.set_alpha(0.5*imax / argmax)\n"
     ]
    }
   ],
   "source": [
    "if RUN:\n",
    "    from rknot.events import Travel\n",
    "\n",
    "    params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "    group1 = dict(name='1', n=1, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "    group2 = dict(name='2', n=10, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "    visit2 = Travel(\n",
    "        name='visit2', xy=[9,9], start_tick=3, groups=[0], capacity=1, duration=5, recurring=10\n",
    "    )\n",
    "    visit1 = Travel(\n",
    "        name='visit1', xy=[1,1], start_tick=3, groups=[1], capacity=1, duration=5, recurring=10\n",
    "    )\n",
    "    groups = [group1, group2]\n",
    "    events = [visit2, visit1]\n",
    "\n",
    "    sim = Sim(groups=groups, events=events, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, interval=200, dot_size=2000, config='no_details', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/travel2.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/travel2.mp4' controls>alternative text</video>\n",
    "<br>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Quarantine ###\n",
    "\n",
    "A quarantine is an event object that makes several changes to a dots state\n",
    "in order to restrict its movement.\n",
    "\n",
    "When a dot is quarantined,\n",
    "    \n",
    "1. it goes back to its home location ([see Dot Matrix](#Dot-Matrix))\n",
    "2. its boxes and gates are reset to match its group\n",
    "3. its mover function is changed to 'quarantine'\n",
    "\n",
    "In addition, a Quarantine object will create a additional restriction objects that disallow events during the quarantine ([see Restrictions below](#Restrictions))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "from rknot.events import Quarantine\n",
    "\n",
    "params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "group1 = dict(name='1', n=2, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "group2 = dict(name='2', n=2, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "quar = Quarantine(name='all', start_tick=5, groups=[0,1], duration=30)\n",
    "\n",
    "groups = [group1, group2]\n",
    "events = [quar]\n",
    "\n",
    "sim = Sim(groups=groups, events=events, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, interval=200, dot_size=2000, config='no_details', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "if RUN:\n",
    "    from rknot.events import Quarantine\n",
    "\n",
    "    params = {'square': 10, 'Ro': 2.5, 'days': 50, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "    group1 = dict(name='1', n=2, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "    group2 = dict(name='2', n=2, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "    quar = Quarantine(name='all', start_tick=5, groups=[0,1], duration=30)\n",
    "\n",
    "    groups = [group1, group2]\n",
    "    events = [quar]\n",
    "\n",
    "    sim = Sim(groups=groups, events=events, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, interval=200, dot_size=2000, config='no_details', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/quar1.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/quar1.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We can see from above that once in quaratine, the subjects barely move. We can include events in our structure. The events will be restricted during the quarantine period, then will resume when the quarantine ends."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "params = {'square': 10, 'Ro': 2.5, 'days': 100, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "group1 = dict(name='1', n=1, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "group2 = dict(name='2', n=10, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "show = Event(name='show', xy=(6,6), start_tick=5, groups=[1], capacity=5, recurring=30)\n",
    "visit2 = Travel(\n",
    "    name='visit2', xy=[9,9], start_tick=3, groups=[0], capacity=1, duration=5, recurring=10\n",
    ")\n",
    "visit1 = Travel(\n",
    "    name='visit1', xy=[1,1], start_tick=3, groups=[1], capacity=1, duration=5, recurring=10\n",
    ")\n",
    "\n",
    "groups = [group1, group2]\n",
    "events = [show, visit2, visit1, quar]\n",
    "\n",
    "sim = Sim(groups=groups, events=events, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, interval=200, dot_size=2000, config='no_details', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 53,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "b3a900ba84894123a1a67034262fa5e1",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "6bdad3b248ce4fbf8bc06b6a55d11a99",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=101.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:323: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.max.set_alpha(0.5*i_currmax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:327: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.hit.set_alpha(0.5*imax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:323: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.max.set_alpha(0.5*i_currmax / argmax)\n",
      "/Users/spindicate/Documents/programming/rknot/rknot/animate/subplots.py:327: RuntimeWarning: invalid value encountered in double_scalars\n",
      "  self.hit.set_alpha(0.5*imax / argmax)\n"
     ]
    }
   ],
   "source": [
    "if RUN:\n",
    "    params = {'square': 10, 'Ro': 2.5, 'days': 100, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "    group1 = dict(name='1', n=1, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "    group2 = dict(name='2', n=10, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "    show = Event(name='show', xy=(6,6), start_tick=5, groups=[1], capacity=5, recurring=30)\n",
    "    visit2 = Travel(\n",
    "        name='visit2', xy=[9,9], start_tick=3, groups=[0], capacity=1, duration=5, recurring=10\n",
    "    )\n",
    "    visit1 = Travel(\n",
    "        name='visit1', xy=[1,1], start_tick=3, groups=[1], capacity=1, duration=5, recurring=10\n",
    "    )\n",
    "\n",
    "    groups = [group1, group2]\n",
    "    events = [show, visit2, visit1, quar]\n",
    "\n",
    "    sim = Sim(groups=groups, events=events, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, interval=200, dot_size=2000, config='no_details', show_intro=False\n",
    "    )    \n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())    \n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/quar2.mp4', writer=FFMpegWriter(fps=5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/quar2.mp4' controls>alternative text</video>\n",
    "<br>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Social Distancing ####\n",
    "Event to mimick social distancing practices.\n",
    "\n",
    "Social distancing is assumed to impact the Transmission Factor, $\\tau$ of each dot. The core hypothesis is that practices such as maintaining 6-feet of distance or mask wearing don't reduce the number of contacts, but do reduce the likelihood that a contact will result in a new infection (ceterus paribus).\n",
    "\n",
    "You can see use of this object [here](hit.ipynb#3.-Social-Distancing)."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Vaccination ###\n",
    "TBD"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### Restrictions ####\n",
    "A restriction object restricts attendance to events that fall within the specified criteria. Each event has a `restricted` attribute that defaults to `False`. A restriction object filters out events from the event schedule by setting `restricted=True` for each event that satisfies the criteria.\n",
    "\n",
    "To clarify, a Restriction is *not* an event. Events act on dots. Restrictions act on events.\n",
    "\n",
    "Restrictions have potential as a versatile tool that can be used to investigate the impact of various government and business policy decisions that impact spread."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The Restriction object has a `criteria` parameter that accepts a `dict`, with keywords related to event object attributes. Acceptable `criteria` keys are currently:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 54,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "from rknot.events import Restriction\n",
    "msg = str(list(Restriction.OPERATORS.keys()))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 55,
   "metadata": {
    "hide_input": true
   },
   "outputs": [
    {
     "data": {
      "text/markdown": [
       "['capacity', 'name', 'ticks', 'groups', 'loc_id']"
      ],
      "text/plain": [
       "<IPython.core.display.Markdown object>"
      ]
     },
     "execution_count": 55,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "md(msg)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The simplest way to restrict an event is to restrict it by its name."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "from rknot.events import Restriction\n",
    "\n",
    "params = {'square': 10, 'Ro': 2.5, 'days': 100, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "group1 = dict(name='1', n=10, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "group2 = dict(name='2', n=10, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "show1 = Event(name='show1', xy=(1,1), start_tick=2, groups=[0], capacity=10, recurring=2)\n",
    "show2 = Event(name='show2', xy=(10,10), start_tick=2, groups=[1], capacity=10, recurring=2)\n",
    "\n",
    "\n",
    "criteria = {'name': 'show1'}\n",
    "res1 = Restriction(name='no_show1', start_tick=10, duration=20, criteria=criteria)\n",
    "\n",
    "groups = [group1, group2]\n",
    "events = [show1, show2, res1]\n",
    "\n",
    "sim = Sim(groups=groups, events=events, **params)\n",
    "sim.run(dotlog=True)\n",
    "\n",
    "chart = Chart(\n",
    "    sim, interval=300, dot_size=2000, config='no_details', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 57,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "7f888fbfcf884a4188dea707d69791a2",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "a577c7352bd54fc18a4634765ad7407c",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=101.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "if RUN:\n",
    "    from rknot.events import Restriction\n",
    "\n",
    "    params = {'square': 10, 'Ro': 2.5, 'days': 100, 'imndur': 365, 'infdur': 365}\n",
    "\n",
    "    group1 = dict(name='1', n=10, n_inf=1, box=[1,5,1,5], box_is_gated=True)\n",
    "    group2 = dict(name='2', n=10, n_inf=0, box=[6,10,6,10], box_is_gated=True)\n",
    "\n",
    "    show1 = Event(name='show1', xy=(1,1), start_tick=2, groups=[0], capacity=10, recurring=2)\n",
    "    show2 = Event(name='show2', xy=(10,10), start_tick=2, groups=[1], capacity=10, recurring=2)\n",
    "\n",
    "\n",
    "    criteria = {'name': 'show1'}\n",
    "    res1 = Restriction(name='no_show1', start_tick=10, duration=20, criteria=criteria)\n",
    "\n",
    "    groups = [group1, group2]\n",
    "    events = [show1, show2, res1]\n",
    "\n",
    "    sim = Sim(groups=groups, events=events, **params)\n",
    "    sim.run(dotlog=True)\n",
    "    chart = Chart(\n",
    "        sim, interval=300, dot_size=2000, config='no_details', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())      \n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/restrict1.mp4', writer=FFMpegWriter(fps=2.5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/restrict1.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "In the above, we can see that every other day both group boxes have events that are attended by all dots in the group.\n",
    "\n",
    "But on day 10, the `group1` dots no longer converge on location `(1,1)`. Instead, they are spread throughout their box. So `res1` has successfully restricted attendance to `show1`.\n",
    "\n",
    "Unlike `Quarantine` objects, however, the `group1` dots have not changed their standard movement patterns. The dots simply revert to their designated `mover` function (in fact, `Quarantine` *is* an event object and it creates `Restriction` objects internally to eliminate events during the quarantine.\n",
    "\n",
    "We can restrict multiple events via the other criteria. Next we will restrict events based on their capacity. Events with more than 5 subjects in attendance will be restricted."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```python\n",
    "criteria = {'capacity': 5}\n",
    "res1 = Restriction(name='cap5', start_tick=10, duration=20, criteria=criteria)\n",
    "\n",
    "groups = [group1, group2]\n",
    "events = [show1, show2, res1]\n",
    "\n",
    "sim = Sim(groups=groups, events=events, **params)\n",
    "sim.run()\n",
    "\n",
    "chart = Chart(\n",
    "    sim, interval=300, dot_size=2000, config='no_details', show_intro=False\n",
    ")\n",
    "chart.animate.to_html5_video()\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 59,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "c86f924130fd4ba1bebf481a13af86b2",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "053a53fe44da42349ce3cdb615f27a75",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(FloatProgress(value=0.0, max=101.0), HTML(value='')))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "\n",
      "\n",
      "\n"
     ]
    }
   ],
   "source": [
    "if RUN:\n",
    "    criteria = {'capacity': 5}\n",
    "    res1 = Restriction(name='cap5', start_tick=10, duration=20, criteria=criteria)\n",
    "\n",
    "    groups = [group1, group2]\n",
    "    events = [show1, show2, res1]\n",
    "\n",
    "    sim = Sim(groups=groups, events=events, **params)\n",
    "    sim.run()\n",
    "    chart = Chart(\n",
    "        sim, interval=300, dot_size=2000, config='no_details', show_intro=False\n",
    "    )\n",
    "if SHOW_CHARTS:\n",
    "    HTML(chart.animate.to_html5_video())\n",
    "if SAVE_CHARTS:\n",
    "    chart.animate.save('vids/concepts/restrict2.mp4', writer=FFMpegWriter(fps=2.5))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<video width='705' height='340' \n",
    "    src='https://storage.googleapis.com/rknotvids/keycons/restrict2.mp4' controls>alternative text</video>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "In the above we see that neither of the groups had events from day 10 onward during the quarantine period."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Restrictions can be chained together as desired to form a complex and tailored policy recipe for the population of the sim. [See this example](hit.ipynb#A-Fulsome-Scenario)."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Dot Matrix ###"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 60,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "from rknot.dots import MATRIX_LABELS as LABELS\n",
    "msg = \"The dot matrix is essentially RKnot's canonical form of data structure. \"\n",
    "msg += \"The matrix is simply a 2D `numpy` array of shape $n*${} \".format(len(LABELS))\n",
    "msg += \"with each of the $n$ rows representing a dot and each column representing \"\n",
    "msg += \"an attribute. These attributes have the same functionality as any attribute \"\n",
    "msg += \"on a class object.\\n\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 61,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/markdown": [
       "The **Dot Matrix** is essentially RKnot's canonical form of data structure. The matrix is simply a 2D `numpy` array of shape $n*$21 with each of the $n$ rows representing a dot and each column representing an attribute. These attributes have the same functionality as any attribute on a class object.\n"
      ],
      "text/plain": [
       "<IPython.core.display.Markdown object>"
      ]
     },
     "execution_count": 61,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "md(msg)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " More typical Python objects have been eschewed in favor the Dot Matrix because:\n",
    "\n",
    "* **RKnot** relies heavily on [Ray](https://docs.ray.io/en/latest/) for parallel processing and [Numba](https://numba.pydata.org/) for just-in-time compilation and vectorization to improve processing speed.\n",
    "* `Numpy` arrays have several advantages in **Ray** including [rapid serialization](https://ray-project.github.io/2017/10/15/fast-python-serialization-with-ray-and-arrow.html) and ease of batching.\n",
    "* **Numba** also integrates well with `numpy`, providing many of its features and leads to major performance improvements.\n",
    "* Aside from **Ray** and **Numba**, the object approach is much slower, more cumbersome, and more memory intensive than the simple data structure deployed in **RKnot**."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The dot matrix is created inside a **Ray** actor at instantiation and is only passed back to the main `Sim` object when the simulation is completed.\n",
    "\n",
    "It can be accessed via the `dots` attribute. Below is a 4 dot sample:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 62,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "array([[   0,    0,    1,    0,    0,    1,    1,   13,    2,    4,    2,\n",
       "           4,    1,    1, -999,    0,  100,  650,   -1,  373,  738,    0,\n",
       "           1],\n",
       "       [   1,    0,    1,    0,    0,    1,    1,   12,    2,    3,    2,\n",
       "           3,    1,    1, -999,    0,  100,  650,   -1,  369,  734,    0,\n",
       "           1],\n",
       "       [   2,    0,    1,    0,    0,    1,    1,    4,    1,    5,    1,\n",
       "           5,    1,    1, -999,    0,  100,  650,   -1,  373,  738,    0,\n",
       "           1],\n",
       "       [   3,    0,    1,    0,    0,    1,    1,    4,    1,    5,    1,\n",
       "           5,    1,    1, -999,    0,  100,  650,   -1,  371,  736,    0,\n",
       "           1]])"
      ]
     },
     "execution_count": 62,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sim.dots[:4]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 63,
   "metadata": {
    "hide_input": true,
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "msg = \"Labels for the individual columns are available via the `MATRIX_LABELS` property. \""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 64,
   "metadata": {
    "hide_input": true
   },
   "outputs": [
    {
     "data": {
      "text/markdown": [
       "Labels for the individual columns are available via the `MATRIX_LABELS` property. "
      ],
      "text/plain": [
       "<IPython.core.display.Markdown object>"
      ]
     },
     "execution_count": 64,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "md(msg)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 65,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "['id', 'group_id', 'is_alive', 'is_vaxxed', 'is_sus', 'is_inf', 'ever_inf', 'loc_id', 'x', 'y', 'homex', 'homey', 'go_home', 'box_id', 'event_id', 'mover', 'tmf', 'ifr', 'depart', 'recover', 'relapse']\n"
     ]
    }
   ],
   "source": [
    "from rknot.dots import MATRIX_LABELS, MATRIX_COL_DEFNS as DEFNS\n",
    "print (MATRIX_LABELS)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "With the labels, the matrix above could be shown in a table, as follows:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 66,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "msg = '| ' + ' '.join(['{} |'.format(label) for label in MATRIX_LABELS])\n",
    "msg += ' \\n'\n",
    "msg += '| ' + ' '.join([':---: |' for label in MATRIX_LABELS])\n",
    "for dot in sim.dots[:5]:\n",
    "    msg += ' \\n'\n",
    "    msg += '| ' + ' '.join(['{} |'.format(dot[i]) for i, label in enumerate(MATRIX_LABELS)])    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 67,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/markdown": [
       "| id | group_id | is_alive | is_vaxxed | is_sus | is_inf | ever_inf | loc_id | x | y | homex | homey | go_home | box_id | event_id | mover | tmf | ifr | depart | recover | relapse | \n",
       "| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | \n",
       "| 0 | 0 | 1 | 0 | 0 | 1 | 1 | 13 | 2 | 4 | 2 | 4 | 1 | 1 | -999 | 0 | 100 | 650 | -1 | 373 | 738 | \n",
       "| 1 | 0 | 1 | 0 | 0 | 1 | 1 | 12 | 2 | 3 | 2 | 3 | 1 | 1 | -999 | 0 | 100 | 650 | -1 | 369 | 734 | \n",
       "| 2 | 0 | 1 | 0 | 0 | 1 | 1 | 4 | 1 | 5 | 1 | 5 | 1 | 1 | -999 | 0 | 100 | 650 | -1 | 373 | 738 | \n",
       "| 3 | 0 | 1 | 0 | 0 | 1 | 1 | 4 | 1 | 5 | 1 | 5 | 1 | 1 | -999 | 0 | 100 | 650 | -1 | 371 | 736 | \n",
       "| 4 | 0 | 1 | 0 | 0 | 1 | 1 | 1 | 1 | 2 | 1 | 2 | 1 | 1 | -999 | 0 | 100 | 650 | -1 | 367 | 732 |"
      ],
      "text/plain": [
       "<IPython.core.display.Markdown object>"
      ]
     },
     "execution_count": 67,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "md(msg)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "There are several data types at work:    \n",
    "* *categorical integers*; used to identify related objects\n",
    "    * `id`, `group_id`, `loc_id`, `box_id`, `event_id`, `mover`\n",
    "* *boolean integers*; used to set boolean flags\n",
    "    * `0 means False` and `1 means True`\n",
    "    * `is_alive`, `is_vaxxed`, `is_sus`, `is_inf`, `ever_inf`, `go_home`\n",
    "* *coordinates*; used to identify locations\n",
    "    * `x`, `y`, `homex`, `homey`\n",
    "* *event ticks*; integers that trigger an event on the given tick\n",
    "    * `depart`, `recover`, `relapse`\n",
    "* *factors*; scaled integers that must be unscaled before being used in multiplicative formulas\n",
    "    * `tmf`, `ifr`"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The column attributes are defined as follows:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 68,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [],
   "source": [
    "table = '| Label | Definition '*2 + '|'\n",
    "table += ' \\n'\n",
    "table += '|:---:|:---'*2 + '|'\n",
    "table += ' \\n'\n",
    "defns = list(DEFNS.items())\n",
    "tablen = len(defns) // 2\n",
    "for i,j in zip(defns[:tablen], defns[tablen:]):\n",
    "    table += '| ' + i[0] + ' | ' + i[1] + ' |' + j[0] + ' | ' + j[1] + ' |'\n",
    "    table += '\\n'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 69,
   "metadata": {
    "remove_input": true
   },
   "outputs": [
    {
     "data": {
      "text/markdown": [
       "| Label | Definition | Label | Definition | \n",
       "|:---:|:---|:---:|:---| \n",
       "| id | the subject's unique identifier  |homex | x coord of the subject's home location (its original starting point)  |\n",
       "| group_id | the unique identifier of the subject's group  |homey | y coord of the subject's home location (its original starting point)  |\n",
       "| is_alive | Is the subject alive?  |go_home | is the subject going home on the next move? |\n",
       "| is_vaxxed | Has the subject been vaccinated?  |box_id | id of the box the subject belongs to  |\n",
       "| is_sus | Is the subject susceptible to infection?  |event_id | id of the event the subject is attending  |\n",
       "| is_inf | Is the subject infected?  |mover | id of the subject's mover function |\n",
       "| ever_inf | Has the subject ever been infected?  |tmf | the subject's transmission factor  |\n",
       "| loc_id | id of the subject's current location  |ifr | the subject's infection fatality rate  |\n",
       "| x | x coord of the subject's current location  |depart | the date an infected subject will depart |\n",
       "| y | y coord of the subject's curretn location  |recover | the date an infected subject will no longer be infected or susceptible  |\n"
      ],
      "text/plain": [
       "<IPython.core.display.Markdown object>"
      ]
     },
     "execution_count": 69,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "md(table)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 72,
   "metadata": {
    "nbsphinx": "hidden"
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "'/Users/spindicate/Documents/programming/rknot/docs/docs/concepts.ipynb'"
      ]
     },
     "execution_count": 72,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import os\n",
    "dir_ = os.getcwd()\n",
    "dir_docs = dir_ + '/docs/docs'\n",
    "filename = '/concepts.ipynb'\n",
    "\n",
    "from shutil import copyfile\n",
    "copyfile(dir_ + filename, dir_docs + filename)"
   ]
  }
 ],
 "metadata": {
  "celltoolbar": "Edit Metadata",
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
